<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI圖片優化助手</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- 頂部導航欄 -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 32 32">
                    <circle cx="16" cy="16" r="14" fill="none" stroke="#007AFF" stroke-width="2"/>
                    <path d="M8 16 L14 22 L24 10" stroke="#007AFF" stroke-width="2" fill="none"/>
                    <circle cx="16" cy="16" r="6" fill="#007AFF" opacity="0.2"/>
                </svg>
                <h1>AI圖片優化助手</h1>
            </div>
            <div class="header-actions">
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userPhone"></span>
                    <span class="plan-badge" id="planBadge">免費版</span>
                </div>
                <button class="btn btn-secondary" id="helpBtn">
                    <i class="fas fa-question-circle"></i>
                    幫助
                </button>
                <button class="btn btn-primary" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                    設置
                </button>
                <button class="btn btn-danger" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                    登出
                </button>
            </div>
        </div>
    </header>

    <!-- 主要內容區域 -->
    <main class="main-content">
        <!-- 左側面板 - 圖片上傳和管理 -->
        <div class="left-panel">
            <!-- 圖片上傳區域 -->
            <div class="upload-section">
                <h2>圖片管理</h2>
                <div class="upload-hint-top">支持 JPG、PNG、GIF、WEBP、BMP 格式</div>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>拖拽或點擊上傳</p>
                        <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                        <button class="btn btn-primary" id="selectFileBtn">
                            選擇文件
                        </button>
                    </div>
                </div>
                
                <!-- 已上傳圖片列表 -->
                <div class="uploaded-images" id="uploadedImages">
                    <h3>已上傳圖片</h3>
                    <div class="image-navigation">
                        <button class="nav-btn nav-left" id="navLeft" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="image-list" id="imageList"></div>
                        <button class="nav-btn nav-right" id="navRight" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="uploaded-count-hint" id="uploadedCountHint">
                        總計：0 張圖片
                    </div>
                </div>
                
                <!-- 處理進度條 -->
                <div class="processing-progress" id="processingProgress" style="display: none;">
                    <div class="progress-info">
                        <span id="progressStatusText">就緒</span>
                        <span id="progressPercentage">0%</span>
                    </div>
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 中間面板 - 圖片預覽和下載 -->
        <div class="center-panel">
            <!-- 圖片預覽區域 -->
            <div class="preview-section">
                <h2>圖片預覽</h2>
                <div class="preview-hint-top">點擊左側圖片預覽</div>
                <div class="preview-container" id="previewContainer">
                    <div class="preview-placeholder">
                        <i class="fas fa-image"></i>
                        <p>等待圖片</p>
                    </div>
                </div>
                
                <!-- 預覽控制 -->
                <div class="preview-controls">
                    <button class="btn btn-secondary" id="prevBtn" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="imageCounter">0 / 0</span>
                    <button class="btn btn-secondary" id="nextBtn" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <!-- 下載快捷按鈕 -->
                <div class="download-quick-actions">
                    <button class="btn btn-primary" id="downloadCurrent" disabled>
                        <i class="fas fa-download"></i>
                        下載當前圖片
                    </button>
                    <button class="btn btn-secondary" id="downloadAll" disabled>
                        <i class="fas fa-download"></i>
                        下載所有圖片
                    </button>
                </div>
            </div>
        </div>

        <!-- 右側面板 - 處理工具 -->
        <div class="right-panel">
            <!-- 處理工具面板 -->
            <div class="tools-section">
                <h2>處理工具</h2>
                <div class="tools-hint-top">選擇圖片後使用工具處理</div>
                <div class="tools-tabs">
                    <button class="tab-btn active" data-tab="basic">基礎處理</button>
                    <button class="tab-btn" data-tab="advanced">高級處理</button>
                    <button class="tab-btn" data-tab="effects">特效濾鏡</button>
                    <button class="tab-btn" data-tab="ai">AI處理</button>
                    <button class="tab-btn" data-tab="drawing">塗鴉標註</button>
                </div>
                <div class="tools-content">
                
                <!-- 基礎處理工具 -->
                <div class="tab-content active" id="basic">
                    <div class="tool-group">
                        <h3>基礎處理</h3>
                        <div class="tool-buttons">
                            <button class="tool-btn" data-action="brighten">提亮</button>
                            <button class="tool-btn" data-action="contrast">增加對比度</button>
                            <button class="tool-btn" data-action="grayscale">黑白濾鏡</button>
                            <button class="tool-btn" data-action="sepia">復古濾鏡</button>
                            <button class="tool-btn" data-action="invert">反轉濾鏡</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>參數調節</h3>
                        <div class="parameter-controls">
                            <label>亮度: <input type="range" id="brightness" min="-100" max="100" value="0"></label>
                            <label>對比度: <input type="range" id="contrast" min="-100" max="100" value="0"></label>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>格式轉換</h3>
                        <div class="format-controls">
                            <select id="outputFormat">
                                <option value="jpeg">JPEG</option>
                                <option value="png">PNG</option>
                            </select>
                            <input type="number" id="quality" min="1" max="100" value="90" placeholder="質量">
                            <button class="btn btn-primary" id="convertFormat">轉換格式</button>
                        </div>
                    </div>
                </div>
                
                <!-- 高級處理工具 -->
                <div class="tab-content" id="advanced">
                    <div class="tool-group">
                        <h3>濾鏡效果</h3>
                        <div class="filter-grid">
                            <button class="filter-btn" data-filter="grayscale">黑白</button>
                            <button class="filter-btn" data-filter="sepia">復古</button>
                            <button class="filter-btn" data-filter="invert">反轉</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>圖片調整</h3>
                        <div class="tool-buttons">
                            <button class="tool-btn" data-action="brighten">提亮</button>
                            <button class="tool-btn" data-action="contrast">增加對比度</button>
                        </div>
                    </div>
                </div>
                
                <!-- 特效濾鏡工具 -->
                <div class="tab-content" id="effects">
                    <div class="tool-group">
                        <h3>藝術濾鏡</h3>
                        <div class="filter-grid">
                            <button class="filter-btn" data-filter="grayscale">黑白</button>
                            <button class="filter-btn" data-filter="sepia">復古</button>
                            <button class="filter-btn" data-filter="invert">反轉</button>
                            <button class="filter-btn" data-filter="blur">模糊</button>
                            <button class="filter-btn" data-filter="sharpen">銳化</button>
                            <button class="filter-btn" data-filter="vintage">懷舊</button>
                            <button class="filter-btn" data-filter="warm">暖色調</button>
                            <button class="filter-btn" data-filter="cool">冷色調</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>相框效果</h3>
                        <div class="frame-grid">
                            <button class="frame-btn" data-frame="classic">經典相框</button>
                            <button class="frame-btn" data-frame="modern">現代相框</button>
                            <button class="frame-btn" data-frame="vintage">復古相框</button>
                            <button class="frame-btn" data-frame="elegant">優雅相框</button>
                            <button class="frame-btn" data-frame="minimal">極簡相框</button>
                            <button class="frame-btn" data-frame="artistic">藝術相框</button>
                        </div>
                    </div>
                </div>
                
                <!-- AI處理工具 -->
                <div class="tab-content" id="ai">
                    <div class="tool-group" id="aiLockedMessage" style="display: none;">
                        <div class="ai-locked-message">
                            <i class="fas fa-lock" style="font-size: 48px; color: #ffa502; margin-bottom: 20px;"></i>
                            <h3>AI功能已鎖定</h3>
                            <p>您需要升級到專業版才能使用AI智能處理功能</p>
                            <button class="btn btn-primary" id="upgradeBtn">
                                <i class="fas fa-crown"></i>
                                立即升級
                            </button>
                        </div>
                    </div>
                    
                    <div class="tool-group" id="aiTools" style="display: none;">
                        <h3>畫質修復</h3>
                        <div class="ai-tools">
                            <button class="ai-btn" data-ai="repair-old-photo">
                                <i class="fas fa-magic"></i>
                                老照片修復
                            </button>
                            <button class="ai-btn" data-ai="upscale-8k">
                                <i class="fas fa-expand-arrows-alt"></i>
                                8K超分辨率
                            </button>
                        </div>
                    </div>
                    
                    <div class="tool-group" id="aiTools2" style="display: none;">
                        <h3>智能一鍵修復</h3>
                        <div class="ai-tools">
                            <button class="ai-btn" data-ai="select-and-repair">
                                <i class="fas fa-crop-alt"></i>
                                選擇區域並一鍵修復
                            </button>
                            <button class="ai-btn" data-ai="one-click-repair">
                                <i class="fas fa-user-check"></i>
                                全圖智能修復
                            </button>
                        </div>
                    </div>
                    
                    <div class="tool-group" id="aiTools3" style="display: none;">
                        <h3>智能摳圖</h3>
                        <div class="ai-tools">
                            <button class="ai-btn" data-ai="extract-portrait">
                                <i class="fas fa-user"></i>
                                人像分離
                            </button>
                            <button class="ai-btn" data-ai="extract-object">
                                <i class="fas fa-cut"></i>
                                物體摳圖
                            </button>
                        </div>
                    </div>
                    
                    <div class="tool-group" id="aiTools4" style="display: none;">
                        <h3>風格化生成</h3>
                        <div class="ai-tools">
                            <button class="ai-btn" data-ai="artistic-oil">
                                <i class="fas fa-palette"></i>
                                油畫風格
                            </button>
                            <button class="ai-btn" data-ai="artistic-watercolor">
                                <i class="fas fa-paint-brush"></i>
                                水彩風格
                            </button>
                            <button class="ai-btn" data-ai="artistic-sketch">
                                <i class="fas fa-pencil-alt"></i>
                                素描風格
                            </button>
                            <button class="ai-btn" data-ai="artistic-cartoon">
                                <i class="fas fa-smile"></i>
                                卡通風格
                            </button>
                            <button class="ai-btn" data-ai="artistic-vintage">
                                <i class="fas fa-camera-retro"></i>
                                復古風格
                            </button>
                            <button class="ai-btn" data-ai="cartoonize">
                                <i class="fas fa-child"></i>
                                卡通化
                            </button>
                        </div>
                    </div>
                    
                    <div class="tool-group" id="aiStatus" style="display: none;">
                        <h3>AI處理狀態</h3>
                        <div class="ai-status">
                            <div class="status-indicator" id="aiStatusIndicator">
                                <span class="status-text">就緒</span>
                            </div>
                            <div class="ai-progress" id="aiProgress" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="aiProgressFill"></div>
                                </div>
                                <span class="progress-text" id="aiProgressText">處理中...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 塗鴉標註工具 -->
                <div class="tab-content" id="drawing">
                    <div class="tool-group">
                        <h3>繪製工具</h3>
                        <div class="drawing-tools">
                            <button class="drawing-btn active" data-tool="brush">畫筆</button>
                            <button class="drawing-btn" data-tool="eraser">橡皮擦</button>
                            <button class="drawing-btn" data-tool="spray">噴漆</button>
                            <button class="drawing-btn" data-tool="neon">霓虹</button>
                            <button class="drawing-btn" data-tool="sparkle">閃爍</button>
                            <button class="drawing-btn" data-tool="line">直線</button>
                            <button class="drawing-btn" data-tool="rectangle">矩形</button>
                            <button class="drawing-btn" data-tool="circle">圓形</button>
                            <button class="drawing-btn" data-tool="text">文字</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>特效工具</h3>
                        <div class="special-effects">
                            <button class="effect-btn" data-effect="heart">愛心</button>
                            <button class="effect-btn" data-effect="star">星星</button>
                            <button class="effect-btn" data-effect="explosion">爆炸</button>
                            <button class="effect-btn" data-effect="emoji">表情</button>
                            <button class="effect-btn" data-effect="bubble">對話框</button>
                            <button class="effect-btn" data-effect="progress">進度條</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>標註工具</h3>
                        <div class="annotation-tools">
                            <button class="annotation-btn" data-annotation="arrow">箭頭</button>
                            <button class="annotation-btn" data-annotation="neon-arrow">霓虹箭頭</button>
                            <button class="annotation-btn" data-annotation="highlight">高亮</button>
                            <button class="annotation-btn" data-annotation="stamp">印章</button>
                            <button class="annotation-btn" data-annotation="measure">測量</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>畫筆樣式</h3>
                        <div class="brush-styles">
                            <button class="style-btn active" data-style="solid">實線</button>
                            <button class="style-btn" data-style="gradient">漸變</button>
                            <button class="style-btn" data-style="rainbow">彩虹</button>
                            <button class="style-btn" data-style="glow">發光</button>
                            <button class="style-btn" data-style="dotted">虛點</button>
                            <button class="style-btn" data-style="dashed">虛線</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>顏色設置</h3>
                        <div class="color-controls">
                            <div class="color-picker">
                                <label>主色調:</label>
                                <input type="color" id="drawingColor" value="#ff0000">
                            </div>
                            
                            <!-- 新增：预设颜色选择 -->
                            <div class="preset-colors">
                                <label>快速選擇:</label>
                                <div class="color-buttons">
                                    <button class="color-btn active" data-color="#ff0000" style="background-color: #ff0000;" title="紅色"></button>
                                    <button class="color-btn" data-color="#ff6b35" style="background-color: #ff6b35;" title="橙色"></button>
                                    <button class="color-btn" data-color="#ffd23f" style="background-color: #ffd23f;" title="黃色"></button>
                                    <button class="color-btn" data-color="#06ffa5" style="background-color: #06ffa5;" title="綠色"></button>
                                    <button class="color-btn" data-color="#00d4ff" style="background-color: #00d4ff;" title="藍色"></button>
                                    <button class="color-btn" data-color="#a855f7" style="background-color: #a855f7;" title="紫色"></button>
                                    <button class="color-btn" data-color="#ff69b4" style="background-color: #ff69b4;" title="粉色"></button>
                                    <button class="color-btn" data-color="#8b4513" style="background-color: #8b4513;" title="棕色"></button>
                                    <button class="color-btn" data-color="#ffffff" style="background-color: #ffffff; border: 1px solid #ccc;" title="白色"></button>
                                    <button class="color-btn" data-color="#000000" style="background-color: #000000;" title="黑色"></button>
                                    <button class="color-btn" data-color="#ff6b6b" style="background-color: #ff6b6b;" title="珊瑚紅"></button>
                                    <button class="color-btn" data-color="#4ecdc4" style="background-color: #4ecdc4;" title="青綠"></button>
                                    <button class="color-btn" data-color="#45b7d1" style="background-color: #45b7d1;" title="天藍"></button>
                                    <button class="color-btn" data-color="#96ceb4" style="background-color: #96ceb4;" title="薄荷綠"></button>
                                    <button class="color-btn" data-color="#feca57" style="background-color: #feca57;" title="金黃"></button>
                                    <button class="color-btn" data-color="#ff9ff3" style="background-color: #ff9ff3;" title="粉紫"></button>
                                </div>
                            </div>
                            
                            <!-- 新增：渐变色选择 -->
                            <div class="gradient-colors">
                                <label>漸變色彩:</label>
                                <div class="gradient-buttons">
                                    <button class="gradient-btn" data-gradient="sunset" style="background: linear-gradient(45deg, #ff6b6b, #feca57);" title="日落"></button>
                                    <button class="gradient-btn" data-gradient="ocean" style="background: linear-gradient(45deg, #4ecdc4, #45b7d1);" title="海洋"></button>
                                    <button class="gradient-btn" data-gradient="forest" style="background: linear-gradient(45deg, #96ceb4, #06ffa5);" title="森林"></button>
                                    <button class="gradient-btn" data-gradient="sunrise" style="background: linear-gradient(45deg, #ff9ff3, #ff6b35);" title="日出"></button>
                                    <button class="gradient-btn" data-gradient="aurora" style="background: linear-gradient(45deg, #a855f7, #00d4ff);" title="極光"></button>
                                    <button class="gradient-btn" data-gradient="rainbow" style="background: linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #00ff00, #0080ff, #8000ff);" title="彩虹"></button>
                                </div>
                            </div>
                            
                            <div class="size-control">
                                <label>畫筆大小: <span id="brushSizeValue">5px</span></label>
                                <input type="range" id="brushSize" min="1" max="50" value="5">
                            </div>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>操作控制</h3>
                        <div class="action-controls">
                            <button class="btn btn-secondary" id="undoBtn">
                                <i class="fas fa-undo"></i>
                                撤銷
                            </button>
                            <button class="btn btn-secondary" id="redoBtn">
                                <i class="fas fa-redo"></i>
                                重做
                            </button>
                            <button class="btn btn-secondary" id="clearBtn">
                                <i class="fas fa-trash"></i>
                                清空
                            </button>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 設置模態框 -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>設置</h2>
                <button class="modal-close" id="closeSettingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-content">
                    <h3>文件設置</h3>
                    <label>
                        最大文件大小: <input type="number" id="maxFileSize" value="10" min="1" max="50"> MB
                    </label>
                    <label>
                        並行處理數量: <input type="number" id="maxWorkers" value="4" min="1" max="8">
                    </label>
                    
                    <h3>處理設置</h3>
                    <label>
                        <input type="checkbox" id="autoSave" checked>
                        自動保存處理結果
                    </label>
                    <label>
                        <input type="checkbox" id="highQuality">
                        高質量處理模式
                    </label>
                    
                    <h3>下載設置</h3>
                    <label>
                        <input type="checkbox" id="keepOriginal" checked>
                        保留原圖
                    </label>
                    <label>
                        <input type="checkbox" id="createZip">
                        打包下載
                    </label>
                    <label>
                        文件名前綴: <input type="text" id="filenamePrefix" value="processed_">
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- 幫助模態框 -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>使用幫助</h2>
                <button class="modal-close" id="closeHelpModal">&times;</button>
            </div>
            <div class="modal-body">
                <h3>快速開始</h3>
                <ol>
                    <li>上傳圖片：拖拽或點擊上傳按鈕選擇圖片</li>
                    <li>選擇工具：使用右側面板的工具進行圖片處理</li>
                    <li>預覽效果：在預覽區域查看處理結果</li>
                    <li>下載保存：處理完成後下載到本地</li>
                </ol>
                
                <h3>功能特色</h3>
                <ul>
                    <li>智能優化：自動優化圖片質量</li>
                    <li>多種濾鏡：豐富的藝術濾鏡效果</li>
                    <li>精確調整：亮度、對比度等參數調節</li>
                    <li>批量處理：支持多張圖片同時處理</li>
                    <li>格式轉換：支持多種圖片格式轉換</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 隱藏的Canvas元素 -->
    <canvas id="hiddenCanvas" style="display: none;"></canvas>
    
    <!-- 塗鴉標註Canvas -->
    <canvas id="drawingCanvas" style="display: none; position: absolute; top: 0; left: 0; z-index: 1000;"></canvas>
    
    <!-- 認證和權限控制腳本 -->
    <script>
        class AuthManager {
            constructor() {
                this.checkAuth();
                this.initElements();
                this.bindEvents();
            }
            
            checkAuth() {
                const userRole = localStorage.getItem('userRole');
                const userPhone = localStorage.getItem('userPhone');
                
                if (!userRole || !userPhone) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // 如果是管理員，跳轉到管理員儀表板
                if (userRole === 'admin') {
                    window.location.href = 'admin-dashboard.html';
                    return;
                }
                
                this.userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                
                // 檢查是否需要選擇套餐（測試用戶和已付費用戶跳過）
                if (!this.userInfo.isPaid && !this.userInfo.isTestUser) {
                    window.location.href = 'payment.html';
                    return;
                }
                
                // 認證通過，允許繼續使用
                console.log('認證檢查通過，用戶信息:', this.userInfo);
            }
            
            initElements() {
                this.userInfoDiv = document.getElementById('userInfo');
                this.userPhoneSpan = document.getElementById('userPhone');
                this.planBadge = document.getElementById('planBadge');
                this.logoutBtn = document.getElementById('logoutBtn');
                this.upgradeBtn = document.getElementById('upgradeBtn');
                
                this.aiLockedMessage = document.getElementById('aiLockedMessage');
                this.aiTools = document.getElementById('aiTools');
                this.aiTools2 = document.getElementById('aiTools2');
                this.aiTools3 = document.getElementById('aiTools3');
                this.aiTools4 = document.getElementById('aiTools4');
                this.aiStatus = document.getElementById('aiStatus');
            }
            
            bindEvents() {
                this.logoutBtn.addEventListener('click', () => this.logout());
                this.upgradeBtn.addEventListener('click', () => this.upgrade());
                
                // 顯示用戶信息
                this.showUserInfo();
                
                // 控制AI功能權限
                this.controlAIAccess();
            }
            
            showUserInfo() {
                this.userInfoDiv.style.display = 'flex';
                this.userPhoneSpan.textContent = this.userInfo.phone || localStorage.getItem('userPhone');
                
                if (this.userInfo.isPaid || this.userInfo.isTestUser) {
                    this.planBadge.textContent = this.userInfo.isTestUser ? '測試版' : '專業版';
                    this.planBadge.style.background = this.userInfo.isTestUser ? '#9c27b0' : '#2ed573';
                } else {
                    this.planBadge.textContent = '免費版';
                    this.planBadge.style.background = '#ffa502';
                }
                
                this.logoutBtn.style.display = 'block';
            }
            
            controlAIAccess() {
                if (this.userInfo.isPaid || this.userInfo.isTestUser) {
                    // 付費用戶和測試用戶可以訪問所有AI功能
                    this.aiLockedMessage.style.display = 'none';
                    this.aiTools.style.display = 'block';
                    this.aiTools2.style.display = 'block';
                    this.aiTools3.style.display = 'block';
                    this.aiTools4.style.display = 'block';
                    this.aiStatus.style.display = 'block';
                } else {
                    // 免費用戶只能看到升級提示
                    this.aiLockedMessage.style.display = 'block';
                    this.aiTools.style.display = 'none';
                    this.aiTools2.style.display = 'none';
                    this.aiTools3.style.display = 'none';
                    this.aiTools4.style.display = 'none';
                    this.aiStatus.style.display = 'none';
                }
            }
            
            logout() {
                if (confirm('確定要登出嗎？')) {
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('userPhone');
                    localStorage.removeItem('userInfo');
                    window.location.href = 'login.html';
                }
            }
            
            upgrade() {
                window.location.href = 'payment.html';
            }
        }
        
        // 全局錯誤處理
        window.addEventListener('error', function(event) {
            console.error('JavaScript錯誤:', event.error);
            console.error('錯誤位置:', event.filename, '行:', event.lineno, '列:', event.colno);
        });
        
        // 未處理的Promise拒絕
        window.addEventListener('unhandledrejection', function(event) {
            console.error('未處理的Promise拒絕:', event.reason);
        });
        
        // 檢查必要的類和函數
        window.addEventListener('load', function() {
            console.log('頁面加載完成，檢查必要組件...');
            
            // 檢查必要的類
            if (typeof ReliableImageProcessor === 'undefined') {
                console.error('❌ ReliableImageProcessor 類未載入');
            } else {
                console.log('✅ ReliableImageProcessor 類已載入');
            }
            
            if (typeof UIController === 'undefined') {
                console.error('❌ UIController 類未載入');
            } else {
                console.log('✅ UIController 類已載入');
            }
            
            if (typeof Utils === 'undefined') {
                console.error('❌ Utils 工具函數未載入');
            } else {
                console.log('✅ Utils 工具函數已載入');
            }
            
            // 檢查DOM元素
            const fileInput = document.getElementById('fileInput');
            if (!fileInput) {
                console.error('❌ fileInput 元素未找到');
            } else {
                console.log('✅ fileInput 元素已找到');
            }
            
            const uploadArea = document.getElementById('uploadArea');
            if (!uploadArea) {
                console.error('❌ uploadArea 元素未找到');
            } else {
                console.log('✅ uploadArea 元素已找到');
            }
            
            // 檢查工具按鈕
            const toolButtons = document.querySelectorAll('[data-action]');
            console.log(`找到 ${toolButtons.length} 個工具按鈕`);
            
            const filterButtons = document.querySelectorAll('[data-filter]');
            console.log(`找到 ${filterButtons.length} 個濾鏡按鈕`);
            
            const frameButtons = document.querySelectorAll('[data-frame]');
            console.log(`找到 ${frameButtons.length} 個相框按鈕`);
            
            const aiButtons = document.querySelectorAll('[data-ai]');
            console.log(`找到 ${aiButtons.length} 個AI按鈕`);
            
            // 檢查具體的AI按鈕
            aiButtons.forEach((btn, index) => {
                console.log(`AI按鈕 ${index + 1}:`, btn.textContent.trim(), btn.dataset.ai);
            });
        });
        
        // 初始化認證管理器和圖片處理功能
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化認證管理器
            const authManager = new AuthManager();
            
            // 等待認證檢查完成後初始化圖片處理功能
            setTimeout(() => {
                // 檢查是否已登錄
                const userRole = localStorage.getItem('userRole');
                const userPhone = localStorage.getItem('userPhone');
                
                if (userRole && userPhone) {
                    // 用戶已登錄，初始化圖片處理功能
                    if (typeof AIImageOptimizer !== 'undefined') {
                        console.log('初始化圖片處理功能...');
                        // 初始化主應用程序
                        window.app = new AIImageOptimizer();
                        
                        // 確保UIController正確初始化
                        if (window.app && window.app.uiController) {
                            console.log('UIController 已初始化:', window.app.uiController);
                        } else {
                            console.error('UIController 初始化失敗');
                        }
                    } else {
                        console.error('AIImageOptimizer 類未載入');
                    }
                }
            }, 300);
        });
    </script>
    
    <!-- JavaScript文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/reliableImageProcessor.js"></script>
    <script src="js/aiImageProcessor.js"></script>
    <script src="js/drawingProcessor.js"></script>
    <script src="js/uiController.js"></script>
    <script src="js/main.js"></script>
</body>
</html> 