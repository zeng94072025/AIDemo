<!-- 简体中文版本V5.0 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI图片优化助手</title>
    <!-- 引入样式文件 -->
    <link rel="stylesheet" href="styles.css">
    <!-- 引入Font Awesome图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- 顶部导航栏 -->
    <header class="header">
        <div class="header-content">
            <!-- 应用Logo和标题 -->
            <div class="logo">
                <!-- SVG图标：AI智能处理标志 -->
                <svg width="32" height="32" viewBox="0 0 32 32">
                    <circle cx="16" cy="16" r="14" fill="none" stroke="#007AFF" stroke-width="2"/>
                    <path d="M8 16 L14 22 L24 10" stroke="#007AFF" stroke-width="2" fill="none"/>
                    <circle cx="16" cy="16" r="6" fill="#007AFF" opacity="0.2"/>
                </svg>
                <h1>AI图片优化助手</h1>
            </div>
            <!-- 用户操作区域 -->
            <div class="header-actions">
                <!-- 用户信息显示 -->
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userPhone"></span>
                    <span class="plan-badge" id="planBadge">免费版</span>
                </div>
                <!-- 套餐按钮 -->
                <button class="btn btn-secondary" id="plansBtn">
                    <i class="fas fa-crown"></i>
                    套餐
                </button>
                <!-- 帮助按钮 -->
                <button class="btn btn-secondary" id="helpBtn">
                    <i class="fas fa-question-circle"></i>
                    帮助
                </button>
                <!-- 设置按钮 -->
                <button class="btn btn-primary" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                    设置
                </button>
                <!-- 登出按钮 -->
                <button class="btn btn-danger" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                    登出
                </button>
            </div>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <main class="main-content">
        <!-- 左侧面板 - 图片上传和管理 -->
        <div class="left-panel">
            <!-- 图片上传区域 -->
            <div class="upload-section">
                <h2>图片管理</h2>
                <!-- 支持格式提示 -->
                <div class="upload-hint-top">支持 JPG、PNG、GIF、WEBP、BMP 格式</div>
                <!-- 拖拽上传区域 -->
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>拖拽或点击上传</p>
                        <!-- 隐藏的文件输入框 -->
                        <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                        <!-- 选择文件按钮 -->
                        <button class="btn btn-primary" id="selectFileBtn">
                            选择文件
                        </button>
                    </div>
                </div>
                    
                    <!-- 已上传图片列表 -->
                    <div class="uploaded-images" id="uploadedImages">
                        <h3>已上传图片</h3>
                        <div class="image-navigation">
                            <button class="nav-btn nav-left" id="navLeft" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="image-list" id="imageList"></div>
                            <button class="nav-btn nav-right" id="navRight" disabled>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="uploaded-count-hint" id="uploadedCountHint">
                            总计：0 张图片
                        </div>
                    </div>
                    
                    <!-- 处理进度条 -->
                    <div class="processing-progress" id="processingProgress" style="display: none;">
                        <div class="progress-info">
                            <span id="progressStatusText">就绪</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="progress-bar" id="progressBar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- 中间面板 - 图片预览和下载 -->
        <div class="center-panel">
            <!-- 图片预览区域 -->
            <div class="preview-section">
                <h2>图片预览</h2>
                <div class="preview-hint-top">点击左侧图片预览</div>
                <div class="preview-container" id="previewContainer">
                    <div class="preview-placeholder">
                        <i class="fas fa-image"></i>
                        <p>等待图片</p>
                    </div>
                </div>
                
                <!-- 预览控制 -->
                <div class="preview-controls">
                    <button class="btn btn-secondary" id="prevBtn" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="imageCounter">0 / 0</span>
                    <button class="btn btn-secondary" id="nextBtn" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <!-- 下载快捷按钮 -->
                <div class="download-quick-actions">
                    <button class="btn btn-primary" id="downloadCurrent" disabled>
                        <i class="fas fa-download"></i>
                        下载处理后效果图
                    </button>
                    <button class="btn btn-secondary" id="downloadAll" disabled>
                        <i class="fas fa-download"></i>
                        批量下载处理后效果图
                    </button>
                </div>
            </div>
        </div>

        <!-- 右侧面板 - 处理工具 -->
        <div class="right-panel">
            <!-- 处理工具面板 -->
            <div class="tools-section">
                <h2>处理工具</h2>
                <div class="tools-hint-top">选择图片后使用工具处理</div>
                <div class="tools-tabs">
                    <button class="tab-btn active" data-tab="basic">基础处理</button>
                    <button class="tab-btn" data-tab="advanced">高级处理</button>
                    <button class="tab-btn" data-tab="effects">特效滤镜</button>
                    <button class="tab-btn" data-tab="ai">AI处理</button>
                    <button class="tab-btn" data-tab="drawing">涂鸦标注</button>
                </div>
                <div class="tools-content">
                
                <!-- 基础处理工具 -->
                <div class="tab-content active" id="basic">
                    <div class="tool-group">
                        <h3>基础处理</h3>
                        <div class="tool-buttons">
                            <button class="tool-btn" data-action="brighten">提亮</button>
                            <button class="tool-btn" data-action="contrast">增加对比度</button>
                            <button class="tool-btn" data-action="grayscale">黑白滤镜</button>
                            <button class="tool-btn" data-action="sepia">复古滤镜</button>
                            <button class="tool-btn" data-action="invert">反转滤镜</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>参数调节</h3>
                        <div class="parameter-controls">
                            <label>亮度: <input type="range" id="brightness" min="-100" max="100" value="0"></label>
                            <label>对比度: <input type="range" id="contrast" min="-100" max="100" value="0"></label>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>格式转换</h3>
                        <div class="format-controls">
                            <select id="outputFormat">
                                <option value="jpeg">JPEG</option>
                                <option value="png">PNG</option>
                            </select>
                            <input type="number" id="quality" min="1" max="100" value="90" placeholder="质量">
                            <button class="btn btn-primary" id="convertFormat">转换格式</button>
                        </div>
                    </div>
                </div>
                
                <!-- 高级处理工具 -->
                <div class="tab-content" id="advanced">
                    <div class="tool-group">
                        <h3>滤镜效果</h3>
                        <div class="filter-grid">
                            <button class="filter-btn" data-filter="grayscale">黑白</button>
                            <button class="filter-btn" data-filter="sepia">复古</button>
                            <button class="filter-btn" data-filter="invert">反转</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>图片调整</h3>
                        <div class="tool-buttons">
                            <button class="tool-btn" data-action="brighten">提亮</button>
                            <button class="tool-btn" data-action="contrast">增加对比度</button>
                        </div>
                    </div>
                </div>
                
                <!-- 特效滤镜工具 -->
                <div class="tab-content" id="effects">
                    <div class="tool-group">
                        <h3>艺术滤镜</h3>
                        <div class="filter-grid">
                            <button class="filter-btn" data-filter="grayscale">黑白</button>
                            <button class="filter-btn" data-filter="sepia">复古</button>
                            <button class="filter-btn" data-filter="invert">反转</button>
                            <button class="filter-btn" data-filter="blur">模糊</button>
                            <button class="filter-btn" data-filter="sharpen">锐化</button>
                            <button class="filter-btn" data-filter="vintage">怀旧</button>
                            <button class="filter-btn" data-filter="warm">暖色调</button>
                            <button class="filter-btn" data-filter="cool">冷色调</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>相框效果</h3>
                        <div class="frame-grid">
                            <button class="frame-btn" data-frame="classic">经典相框</button>
                            <button class="frame-btn" data-frame="modern">现代相框</button>
                            <button class="frame-btn" data-frame="vintage">复古相框</button>
                            <button class="frame-btn" data-frame="elegant">优雅相框</button>
                            <button class="frame-btn" data-frame="minimal">极简相框</button>
                            <button class="frame-btn" data-frame="artistic">艺术相框</button>
                        </div>
                    </div>
                </div>
                
                <!-- AI处理工具 -->
                <div class="tab-content" id="ai">
                    <div class="tool-group" id="aiLockedMessage" style="display: none;">
                        <div class="ai-locked-message">
                            <i class="fas fa-lock" style="font-size: 48px; color: #ffa502; margin-bottom: 20px;"></i>
                            <h3>AI功能已锁定</h3>
                            <p>您需要升级到专业版才能使用AI智能处理功能</p>
                            <button class="btn btn-primary" id="upgradeBtn">
                                <i class="fas fa-crown"></i>
                                立即升级
                            </button>
                        </div>
                    </div>
                    
                    <div class="tool-group" id="aiTools" style="display: none;">
                        <h3>画质修复</h3>
                        <div class="ai-tools">
                            <button class="ai-btn" data-ai="repair-old-photo">
                                <i class="fas fa-magic"></i>
                                老照片修复
                            </button>
                            <button class="ai-btn" data-ai="upscale-8k">
                                <i class="fas fa-expand-arrows-alt"></i>
                                8K超分辨率
                            </button>
                        </div>
                    </div>
                    
                    <div class="tool-group" id="aiTools2" style="display: none;">
                        <h3>智能一键修复</h3>
                        <div class="ai-tools">
                            <button class="ai-btn" data-ai="select-and-repair">
                                <i class="fas fa-crop-alt"></i>
                                选择区域并一键修复
                            </button>
                            <button class="ai-btn" data-ai="one-click-repair">
                                <i class="fas fa-user-check"></i>
                                全图智能修复
                            </button>
                        </div>
                    </div>
                    
                    <div class="tool-group" id="aiTools3" style="display: none;">
                        <h3>智能抠图</h3>
                        <div class="ai-tools">
                            <button class="ai-btn" data-ai="extract-portrait">
                                <i class="fas fa-user"></i>
                                人像分离
                            </button>
                            <button class="ai-btn" data-ai="extract-object">
                                <i class="fas fa-cut"></i>
                                物体抠图
                            </button>
                        </div>
                    </div>
                    
                    <div class="tool-group" id="aiTools4" style="display: none;">
                        <h3>风格化生成</h3>
                        <div class="ai-tools">
                            <button class="ai-btn" data-ai="artistic-oil">
                                <i class="fas fa-palette"></i>
                                油画风格
                            </button>
                            <button class="ai-btn" data-ai="artistic-watercolor">
                                <i class="fas fa-paint-brush"></i>
                                水彩风格
                            </button>
                            <button class="ai-btn" data-ai="artistic-sketch">
                                <i class="fas fa-pencil-alt"></i>
                                素描风格
                            </button>
                            <button class="ai-btn" data-ai="artistic-cartoon">
                                <i class="fas fa-smile"></i>
                                卡通风格
                            </button>
                            <button class="ai-btn" data-ai="artistic-vintage">
                                <i class="fas fa-camera-retro"></i>
                                复古风格
                            </button>
                            <button class="ai-btn" data-ai="cartoonize">
                                <i class="fas fa-child"></i>
                                卡通化
                            </button>
                        </div>
                    </div>
                    
                    <div class="tool-group" id="aiStatus" style="display: none;">
                        <h3>AI处理状态</h3>
                        <div class="ai-status">
                            <div class="status-indicator" id="aiStatusIndicator">
                                <span class="status-text">就绪</span>
                            </div>
                            <div class="ai-progress" id="aiProgress" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="aiProgressFill"></div>
                                </div>
                                <span class="progress-text" id="aiProgressText">处理中...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 涂鸦标注工具 -->
                <div class="tab-content" id="drawing">
                    <div class="tool-group">
                        <h3>绘制工具</h3>
                        <div class="drawing-tools">
                            <button class="drawing-btn active" data-tool="brush">画笔</button>
                            <button class="drawing-btn" data-tool="eraser">橡皮擦</button>
                            <button class="drawing-btn" data-tool="spray">喷漆</button>
                            <button class="drawing-btn" data-tool="neon">霓虹</button>
                            <button class="drawing-btn" data-tool="sparkle">闪烁</button>
                            <button class="drawing-btn" data-tool="line">直线</button>
                            <button class="drawing-btn" data-tool="rectangle">矩形</button>
                            <button class="drawing-btn" data-tool="circle">圆形</button>
                            <button class="drawing-btn" data-tool="text">文字</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>特效工具</h3>
                        <div class="special-effects">
                            <button class="effect-btn" data-effect="heart">爱心</button>
                            <button class="effect-btn" data-effect="star">星星</button>
                            <button class="effect-btn" data-effect="explosion">爆炸</button>
                            <button class="effect-btn" data-effect="emoji">表情</button>
                            <button class="effect-btn" data-effect="bubble">对话框</button>
                            <button class="effect-btn" data-effect="progress">进度条</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>标注工具</h3>
                        <div class="annotation-tools">
                            <button class="annotation-btn" data-annotation="arrow">箭头</button>
                            <button class="annotation-btn" data-annotation="neon-arrow">霓虹箭头</button>
                            <button class="annotation-btn" data-annotation="highlight">高亮</button>
                            <button class="annotation-btn" data-annotation="stamp">印章</button>
                            <button class="annotation-btn" data-annotation="measure">测量</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>画笔样式</h3>
                        <div class="brush-styles">
                            <button class="style-btn active" data-style="solid">实线</button>
                            <button class="style-btn" data-style="gradient">渐变</button>
                            <button class="style-btn" data-style="rainbow">彩虹</button>
                            <button class="style-btn" data-style="glow">发光</button>
                            <button class="style-btn" data-style="dotted">虚点</button>
                            <button class="style-btn" data-style="dashed">虚线</button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>颜色设置</h3>
                        <div class="color-controls">
                            <div class="color-picker">
                                <label>主色调:</label>
                                <input type="color" id="drawingColor" value="#ff0000">
                            </div>
                            
                            <!-- 新增：预设颜色选择 -->
                            <div class="preset-colors">
                                <label>快速选择:</label>
                                <div class="color-buttons">
                                    <button class="color-btn active" data-color="#ff0000" style="background-color: #ff0000;" title="红色"></button>
                                    <button class="color-btn" data-color="#ff6b35" style="background-color: #ff6b35;" title="橙色"></button>
                                    <button class="color-btn" data-color="#ffd23f" style="background-color: #ffd23f;" title="黄色"></button>
                                    <button class="color-btn" data-color="#06ffa5" style="background-color: #06ffa5;" title="绿色"></button>
                                    <button class="color-btn" data-color="#00d4ff" style="background-color: #00d4ff;" title="蓝色"></button>
                                    <button class="color-btn" data-color="#a855f7" style="background-color: #a855f7;" title="紫色"></button>
                                    <button class="color-btn" data-color="#ff69b4" style="background-color: #ff69b4;" title="粉色"></button>
                                    <button class="color-btn" data-color="#8b4513" style="background-color: #8b4513;" title="棕色"></button>
                                    <button class="color-btn" data-color="#ffffff" style="background-color: #ffffff; border: 1px solid #ccc;" title="白色"></button>
                                    <button class="color-btn" data-color="#000000" style="background-color: #000000;" title="黑色"></button>
                                    <button class="color-btn" data-color="#ff6b6b" style="background-color: #ff6b6b;" title="珊瑚红"></button>
                                    <button class="color-btn" data-color="#4ecdc4" style="background-color: #4ecdc4;" title="青绿"></button>
                                    <button class="color-btn" data-color="#45b7d1" style="background-color: #45b7d1;" title="天蓝"></button>
                                    <button class="color-btn" data-color="#96ceb4" style="background-color: #96ceb4;" title="薄荷绿"></button>
                                    <button class="color-btn" data-color="#feca57" style="background-color: #feca57;" title="金黄"></button>
                                    <button class="color-btn" data-color="#ff9ff3" style="background-color: #ff9ff3;" title="粉紫"></button>
                                </div>
                            </div>
                            
                            <!-- 新增：渐变色选择 -->
                            <div class="gradient-colors">
                                <label>渐变色彩:</label>
                                <div class="gradient-buttons">
                                    <button class="gradient-btn" data-gradient="sunset" style="background: linear-gradient(45deg, #ff6b6b, #feca57);" title="日落"></button>
                                    <button class="gradient-btn" data-gradient="ocean" style="background: linear-gradient(45deg, #4ecdc4, #45b7d1);" title="海洋"></button>
                                    <button class="gradient-btn" data-gradient="forest" style="background: linear-gradient(45deg, #96ceb4, #06ffa5);" title="森林"></button>
                                    <button class="gradient-btn" data-gradient="sunrise" style="background: linear-gradient(45deg, #ff9ff3, #ff6b35);" title="日出"></button>
                                    <button class="gradient-btn" data-gradient="aurora" style="background: linear-gradient(45deg, #a855f7, #00d4ff);" title="极光"></button>
                                    <button class="gradient-btn" data-gradient="rainbow" style="background: linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #00ff00, #0080ff, #8000ff);" title="彩虹"></button>
                                </div>
                            </div>
                            
                            <div class="size-control">
                                <label>画笔大小: <span id="brushSizeValue">5px</span></label>
                                <input type="range" id="brushSize" min="1" max="50" value="5">
                            </div>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>操作控制</h3>
                        <div class="action-controls">
                            <button class="btn btn-secondary" id="undoBtn">
                                <i class="fas fa-undo"></i>
                                撤销
                            </button>
                            <button class="btn btn-secondary" id="redoBtn">
                                <i class="fas fa-redo"></i>
                                重做
                            </button>
                            <button class="btn btn-secondary" id="clearBtn">
                                <i class="fas fa-trash"></i>
                                清空
                            </button>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 设置模态框 -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>设置</h2>
                <button class="modal-close" id="closeSettingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-content">
                    <h3>文件设置</h3>
                    <label>
                        最大文件大小: <input type="number" id="maxFileSize" value="10" min="1" max="50"> MB
                    </label>
                    <label>
                        并行处理数量: <input type="number" id="maxWorkers" value="4" min="1" max="8">
                    </label>
                    
                    <h3>处理设置</h3>
                    <label>
                        <input type="checkbox" id="autoSave" checked>
                        自动保存处理结果
                    </label>
                    <label>
                        <input type="checkbox" id="highQuality">
                        高质量处理模式
                    </label>
                    
                    <h3>下载设置</h3>
                    <label>
                        <input type="checkbox" id="keepOriginal" checked>
                        保留原图
                    </label>
                    <label>
                        <input type="checkbox" id="createZip">
                        打包下载
                    </label>
                    <label>
                        文件名前缀: <input type="text" id="filenamePrefix" value="processed_">
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- 帮助模态框 -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>使用帮助</h2>
                <button class="modal-close" id="closeHelpModal">&times;</button>
            </div>
            <div class="modal-body">
                <h3>快速开始</h3>
                <ol>
                    <li>上传图片：拖拽或点击上传按钮选择图片</li>
                    <li>选择工具：使用右侧面板的工具进行图片处理</li>
                    <li>预览效果：在预览区域查看处理结果</li>
                    <li>下载保存：处理完成后下载到本地</li>
                </ol>
                
                <h3>功能特色</h3>
                <ul>
                    <li>智能优化：自动优化图片质量</li>
                    <li>多种滤镜：丰富的艺术滤镜效果</li>
                    <li>精确调整：亮度、对比度等参数调节</li>
                    <li>批量处理：支持多张图片同时处理</li>
                    <li>格式转换：支持多种图片格式转换</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 隐藏的Canvas元素 -->
    <canvas id="hiddenCanvas" style="display: none;"></canvas>
    
    <!-- 涂鸦标注Canvas -->
                    <!-- 涂鸦批注Canvas将在JavaScript中动态插入到processed-image-section内部 -->
    
    <!-- 认证和权限控制脚本 -->
    <script>
        class AuthManager {
            constructor() {
                this.checkAuth();
                this.initElements();
                this.bindEvents();
            }
            
            checkAuth() {
                const userRole = localStorage.getItem('userRole');
                const userPhone = localStorage.getItem('userPhone');
                
                if (!userRole || !userPhone) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // 如果是管理員，跳轉到管理員儀表板
                if (userRole === 'admin') {
                    window.location.href = 'admin-dashboard.html';
                    return;
                }
                
                this.userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                
                // 設置默認套餐為免費版（如果沒有設置）
                if (!this.userInfo.planType) {
                    this.userInfo.planType = 'free';
                    this.userInfo.isPaid = false;
                    localStorage.setItem('userInfo', JSON.stringify(this.userInfo));
                }
                
                // 認證通過，允許繼續使用
                console.log('認證檢查通過，用戶信息:', this.userInfo);
            }
            
            initElements() {
                this.userInfoDiv = document.getElementById('userInfo');
                this.userPhoneSpan = document.getElementById('userPhone');
                this.planBadge = document.getElementById('planBadge');
                this.logoutBtn = document.getElementById('logoutBtn');
                this.plansBtn = document.getElementById('plansBtn');
                
                this.aiLockedMessage = document.getElementById('aiLockedMessage');
                this.aiTools = document.getElementById('aiTools');
                this.aiTools2 = document.getElementById('aiTools2');
                this.aiTools3 = document.getElementById('aiTools3');
                this.aiTools4 = document.getElementById('aiTools4');
                this.aiStatus = document.getElementById('aiStatus');
            }
            
            bindEvents() {
                this.logoutBtn.addEventListener('click', () => this.logout());
                this.plansBtn.addEventListener('click', () => this.openPlans());
                
                // 顯示用戶信息
                this.showUserInfo();
                
                // 控制AI功能權限
                this.controlAIAccess();
            }
            
            showUserInfo() {
                this.userInfoDiv.style.display = 'flex';
                this.userPhoneSpan.textContent = this.userInfo.phone || localStorage.getItem('userPhone');
                
                if (this.userInfo.isPaid || this.userInfo.isTestUser) {
                    this.planBadge.textContent = this.userInfo.isTestUser ? '测试版' : '专业版';
                    this.planBadge.style.background = this.userInfo.isTestUser ? '#9c27b0' : '#2ed573';
                } else {
                    this.planBadge.textContent = '免费版';
                    this.planBadge.style.background = '#ffa502';
                }
                
                this.logoutBtn.style.display = 'block';
            }
            
            controlAIAccess() {
                if (this.userInfo.isPaid || this.userInfo.isTestUser) {
                    // 付費用戶和測試用戶可以訪問所有AI功能
                    this.aiLockedMessage.style.display = 'none';
                    this.aiTools.style.display = 'block';
                    this.aiTools2.style.display = 'block';
                    this.aiTools3.style.display = 'block';
                    this.aiTools4.style.display = 'block';
                    this.aiStatus.style.display = 'block';
                } else {
                    // 免費用戶可以訪問基礎功能，但AI功能需要升級
                    this.aiLockedMessage.style.display = 'block';
                    this.aiTools.style.display = 'none';
                    this.aiTools2.style.display = 'none';
                    this.aiTools3.style.display = 'none';
                    this.aiTools4.style.display = 'none';
                    this.aiStatus.style.display = 'none';
                    
                    // 更新升級提示信息
                    const upgradeMessage = this.aiLockedMessage.querySelector('.upgrade-message');
                    if (upgradeMessage) {
                        const today = new Date().toDateString();
                        const usageKey = `usage_${today}`;
                        const todayUsage = parseInt(localStorage.getItem(usageKey) || '0');
                        const remainingUsage = Math.max(0, 3 - todayUsage);
                        
                        upgradeMessage.innerHTML = `
                            <h3>升級到專業版</h3>
                            <p>今日已使用 ${todayUsage} 次，還剩 ${remainingUsage} 次免費額度</p>
                            <p>升級專業版享受無限制AI處理功能</p>
                            <button class="btn btn-primary" onclick="window.location.href='plans.html'">
                                立即升級
                            </button>
                        `;
                    }
                }
            }
            
            logout() {
                if (confirm('确定要登出吗？')) {
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('userPhone');
                    localStorage.removeItem('userInfo');
                    window.location.href = 'login.html';
                }
            }
            
            openPlans() {
                window.location.href = 'plans.html';
            }
        }
        
        // 全局錯誤處理
        window.addEventListener('error', function(event) {
            console.error('JavaScript錯誤:', event.error);
            console.error('錯誤位置:', event.filename, '行:', event.lineno, '列:', event.colno);
        });
        
        // 未處理的Promise拒絕
        window.addEventListener('unhandledrejection', function(event) {
            console.error('未處理的Promise拒絕:', event.reason);
        });
        
        // 检查必要的类和函数
        window.addEventListener('load', function() {
            console.log('页面加载完成，检查必要组件...');
            
            // 检查必要的类
            if (typeof ReliableImageProcessor === 'undefined') {
                console.error('❌ ReliableImageProcessor 类未加载');
            } else {
                console.log('✅ ReliableImageProcessor 类已加载');
            }
            
            if (typeof UIController === 'undefined') {
                console.error('❌ UIController 类未加载');
            } else {
                console.log('✅ UIController 类已加载');
            }
            
            if (typeof Utils === 'undefined') {
                console.error('❌ Utils 工具函数未加载');
            } else {
                console.log('✅ Utils 工具函数已加载');
            }
            
            // 检查DOM元素
            const fileInput = document.getElementById('fileInput');
            if (!fileInput) {
                console.error('❌ fileInput 元素未找到');
            } else {
                console.log('✅ fileInput 元素已找到');
            }
            
            const uploadArea = document.getElementById('uploadArea');
            if (!uploadArea) {
                console.error('❌ uploadArea 元素未找到');
            } else {
                console.log('✅ uploadArea 元素已找到');
            }
            
            // 检查工具按钮
            const toolButtons = document.querySelectorAll('[data-action]');
            console.log(`找到 ${toolButtons.length} 个工具按钮`);
            
            const filterButtons = document.querySelectorAll('[data-filter]');
            console.log(`找到 ${filterButtons.length} 个滤镜按钮`);
            
            const frameButtons = document.querySelectorAll('[data-frame]');
            console.log(`找到 ${frameButtons.length} 个相框按钮`);
            
            const aiButtons = document.querySelectorAll('[data-ai]');
            console.log(`找到 ${aiButtons.length} 个AI按钮`);
            
            // 检查具体的AI按钮
            aiButtons.forEach((btn, index) => {
                console.log(`AI按钮 ${index + 1}:`, btn.textContent.trim(), btn.dataset.ai);
            });
        });
        
        // 初始化认证管理器和图片处理功能
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化认证管理器
            const authManager = new AuthManager();
            
            // 等待认证检查完成后初始化图片处理功能
            setTimeout(() => {
                // 检查是否已登录
                const userRole = localStorage.getItem('userRole');
                const userPhone = localStorage.getItem('userPhone');
                
                if (userRole && userPhone) {
                    // 用户已登录，初始化图片处理功能
                    if (typeof AIImageOptimizer !== 'undefined') {
                        console.log('初始化图片处理功能...');
                        // 初始化主应用程序
                        window.app = new AIImageOptimizer();
                        
                        // 确保UIController正确初始化
                        if (window.app && window.app.uiController) {
                            console.log('UIController 已初始化:', window.app.uiController);
                        } else {
                            console.error('UIController 初始化失败');
                        }
                    } else {
                        console.error('AIImageOptimizer 类未加载');
                    }
                }
            }, 300);
        });
    </script>
    
    <!-- JavaScript文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/reliableImageProcessor.js"></script>
    <script src="js/aiImageProcessor.js"></script>
    <script src="js/drawingProcessor.js"></script>
    <script src="js/uiController.js"></script>
    <script src="js/usageManager.js"></script>
    <script src="js/main.js"></script>
</body>
</html> 