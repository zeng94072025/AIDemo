<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖片處理功能修復驗證</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f7;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056CC;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .image-item {
            text-align: center;
        }
        .image-item img {
            max-width: 100%;
            max-height: 200px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .test-pass { background: #d4edda; color: #155724; }
        .test-fail { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>圖片處理功能修復驗證</h1>
        
        <div class="section">
            <h3>1. 上傳圖片</h3>
            <input type="file" id="imageInput" accept="image/*">
            <div id="uploadLog" class="log"></div>
        </div>
        
        <div class="section">
            <h3>2. 基礎處理測試</h3>
            <button class="button" id="brightnessBtn" onclick="testBrightness()" disabled>亮度調整</button>
            <button class="button" id="contrastBtn" onclick="testContrast()" disabled>對比度調整</button>
            <button class="button" id="grayscaleBtn" onclick="testGrayscale()" disabled>黑白濾鏡</button>
            <button class="button" id="sepiaBtn" onclick="testSepia()" disabled>復古濾鏡</button>
            <button class="button" id="invertBtn" onclick="testInvert()" disabled>反轉濾鏡</button>
            <div id="basicLog" class="log"></div>
        </div>
        
        <div class="section">
            <h3>3. 高級濾鏡測試</h3>
            <button class="button" id="blurBtn" onclick="testBlur()" disabled>模糊濾鏡</button>
            <button class="button" id="sharpenBtn" onclick="testSharpen()" disabled>銳化濾鏡</button>
            <button class="button" id="vintageBtn" onclick="testVintage()" disabled>懷舊濾鏡</button>
            <button class="button" id="warmBtn" onclick="testWarm()" disabled>暖色調</button>
            <button class="button" id="coolBtn" onclick="testCool()" disabled>冷色調</button>
            <div id="advancedLog" class="log"></div>
        </div>
        
        <div class="section">
            <h3>4. 相框效果測試</h3>
            <button class="button" id="classicBtn" onclick="testFrame('classic')" disabled>經典相框</button>
            <button class="button" id="modernBtn" onclick="testFrame('modern')" disabled>現代相框</button>
            <button class="button" id="vintageFrameBtn" onclick="testFrame('vintage')" disabled>復古相框</button>
            <button class="button" id="elegantBtn" onclick="testFrame('elegant')" disabled>優雅相框</button>
            <button class="button" id="minimalBtn" onclick="testFrame('minimal')" disabled>極簡相框</button>
            <button class="button" id="artisticBtn" onclick="testFrame('artistic')" disabled>藝術相框</button>
            <div id="frameLog" class="log"></div>
        </div>
        
        <div class="section">
            <h3>5. 下載功能測試</h3>
            <button class="button" id="downloadBtn" onclick="testDownload()" disabled>測試下載</button>
            <button class="button" id="base64Btn" onclick="testBase64()" disabled>測試Base64</button>
            <div id="downloadLog" class="log"></div>
        </div>
        
        <div class="section">
            <h3>6. 歷史記錄測試</h3>
            <button class="button" id="undoBtn" onclick="testUndo()" disabled>撤銷</button>
            <button class="button" id="redoBtn" onclick="testRedo()" disabled>重做</button>
            <button class="button" id="resetBtn" onclick="testReset()" disabled>重置</button>
            <div id="historyLog" class="log"></div>
        </div>
        
        <div class="section">
            <h3>7. 圖片預覽</h3>
            <div id="imagePreview" class="image-grid"></div>
        </div>
        
        <div class="section">
            <h3>8. 測試結果</h3>
            <div id="testResults"></div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/reliableImageProcessor.js"></script>
    <script>
        let processor = null;
        let currentFile = null;
        const testResults = [];

        // 初始化
        document.getElementById('imageInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                loadImage(e.target.files[0]);
            }
        });

        // 載入圖片
        async function loadImage(file) {
            try {
                log('uploadLog', '開始載入圖片: ' + file.name, 'info');
                
                processor = new ReliableImageProcessor();
                const imageData = await processor.loadImage(file);
                currentFile = file;
                
                log('uploadLog', '圖片載入成功: ' + JSON.stringify(imageData), 'success');
                
                // 啟用所有測試按鈕
                enableAllButtons();
                
                // 顯示圖片預覽
                showImagePreview();
                
                addTestResult('圖片載入', true, '圖片成功載入到處理器');
                
            } catch (error) {
                log('uploadLog', '圖片載入失敗: ' + error.message, 'error');
                addTestResult('圖片載入', false, error.message);
            }
        }

        // 基礎處理測試
        function testBrightness() {
            if (!processor) return;
            
            const success = processor.adjustBrightness(20);
            if (success) {
                log('basicLog', '亮度調整成功', 'success');
                addTestResult('亮度調整', true, '亮度調整功能正常');
                showImagePreview();
            } else {
                log('basicLog', '亮度調整失敗', 'error');
                addTestResult('亮度調整', false, '亮度調整功能失敗');
            }
        }

        function testContrast() {
            if (!processor) return;
            
            const success = processor.adjustContrast(20);
            if (success) {
                log('basicLog', '對比度調整成功', 'success');
                addTestResult('對比度調整', true, '對比度調整功能正常');
                showImagePreview();
            } else {
                log('basicLog', '對比度調整失敗', 'error');
                addTestResult('對比度調整', false, '對比度調整功能失敗');
            }
        }

        function testGrayscale() {
            if (!processor) return;
            
            const success = processor.applyFilter('grayscale');
            if (success) {
                log('basicLog', '黑白濾鏡應用成功', 'success');
                addTestResult('黑白濾鏡', true, '黑白濾鏡功能正常');
                showImagePreview();
            } else {
                log('basicLog', '黑白濾鏡應用失敗', 'error');
                addTestResult('黑白濾鏡', false, '黑白濾鏡功能失敗');
            }
        }

        function testSepia() {
            if (!processor) return;
            
            const success = processor.applyFilter('sepia');
            if (success) {
                log('basicLog', '復古濾鏡應用成功', 'success');
                addTestResult('復古濾鏡', true, '復古濾鏡功能正常');
                showImagePreview();
            } else {
                log('basicLog', '復古濾鏡應用失敗', 'error');
                addTestResult('復古濾鏡', false, '復古濾鏡功能失敗');
            }
        }

        function testInvert() {
            if (!processor) return;
            
            const success = processor.applyFilter('invert');
            if (success) {
                log('basicLog', '反轉濾鏡應用成功', 'success');
                addTestResult('反轉濾鏡', true, '反轉濾鏡功能正常');
                showImagePreview();
            } else {
                log('basicLog', '反轉濾鏡應用失敗', 'error');
                addTestResult('反轉濾鏡', false, '反轉濾鏡功能失敗');
            }
        }

        // 高級濾鏡測試
        function testBlur() {
            if (!processor) return;
            
            const success = processor.applyFilter('blur');
            if (success) {
                log('advancedLog', '模糊濾鏡應用成功', 'success');
                addTestResult('模糊濾鏡', true, '模糊濾鏡功能正常');
                showImagePreview();
            } else {
                log('advancedLog', '模糊濾鏡應用失敗', 'error');
                addTestResult('模糊濾鏡', false, '模糊濾鏡功能失敗');
            }
        }

        function testSharpen() {
            if (!processor) return;
            
            const success = processor.applyFilter('sharpen');
            if (success) {
                log('advancedLog', '銳化濾鏡應用成功', 'success');
                addTestResult('銳化濾鏡', true, '銳化濾鏡功能正常');
                showImagePreview();
            } else {
                log('advancedLog', '銳化濾鏡應用失敗', 'error');
                addTestResult('銳化濾鏡', false, '銳化濾鏡功能失敗');
            }
        }

        function testVintage() {
            if (!processor) return;
            
            const success = processor.applyFilter('vintage');
            if (success) {
                log('advancedLog', '懷舊濾鏡應用成功', 'success');
                addTestResult('懷舊濾鏡', true, '懷舊濾鏡功能正常');
                showImagePreview();
            } else {
                log('advancedLog', '懷舊濾鏡應用失敗', 'error');
                addTestResult('懷舊濾鏡', false, '懷舊濾鏡功能失敗');
            }
        }

        function testWarm() {
            if (!processor) return;
            
            const success = processor.applyFilter('warm');
            if (success) {
                log('advancedLog', '暖色調濾鏡應用成功', 'success');
                addTestResult('暖色調濾鏡', true, '暖色調濾鏡功能正常');
                showImagePreview();
            } else {
                log('advancedLog', '暖色調濾鏡應用失敗', 'error');
                addTestResult('暖色調濾鏡', false, '暖色調濾鏡功能失敗');
            }
        }

        function testCool() {
            if (!processor) return;
            
            const success = processor.applyFilter('cool');
            if (success) {
                log('advancedLog', '冷色調濾鏡應用成功', 'success');
                addTestResult('冷色調濾鏡', true, '冷色調濾鏡功能正常');
                showImagePreview();
            } else {
                log('advancedLog', '冷色調濾鏡應用失敗', 'error');
                addTestResult('冷色調濾鏡', false, '冷色調濾鏡功能失敗');
            }
        }

        // 相框效果測試
        function testFrame(frameType) {
            if (!processor) return;
            
            const success = processor.applyFrame(frameType);
            if (success) {
                log('frameLog', frameType + '相框應用成功', 'success');
                addTestResult(frameType + '相框', true, frameType + '相框功能正常');
                showImagePreview();
            } else {
                log('frameLog', frameType + '相框應用失敗', 'error');
                addTestResult(frameType + '相框', false, frameType + '相框功能失敗');
            }
        }

        // 下載功能測試
        async function testDownload() {
            if (!processor) return;
            
            try {
                const blob = await processor.toBlob('image/jpeg', 0.9);
                if (blob && blob.size > 0) {
                    log('downloadLog', 'Blob生成成功: ' + blob.size + ' bytes', 'success');
                    addTestResult('Blob生成', true, 'Blob生成功能正常');
                    
                    // 測試下載
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'test-download.jpg';
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    log('downloadLog', '下載測試完成', 'success');
                    addTestResult('下載功能', true, '下載功能正常');
                } else {
                    log('downloadLog', 'Blob生成失敗', 'error');
                    addTestResult('Blob生成', false, 'Blob生成失敗');
                }
            } catch (error) {
                log('downloadLog', '下載測試失敗: ' + error.message, 'error');
                addTestResult('下載功能', false, error.message);
            }
        }

        function testBase64() {
            if (!processor) return;
            
            const base64 = processor.toBase64();
            if (base64 && base64.length > 100) {
                log('downloadLog', 'Base64生成成功: ' + base64.length + ' characters', 'success');
                addTestResult('Base64生成', true, 'Base64生成功能正常');
            } else {
                log('downloadLog', 'Base64生成失敗', 'error');
                addTestResult('Base64生成', false, 'Base64生成失敗');
            }
        }

        // 歷史記錄測試
        function testUndo() {
            if (!processor) return;
            
            const success = processor.undo();
            if (success) {
                log('historyLog', '撤銷操作成功', 'success');
                addTestResult('撤銷功能', true, '撤銷功能正常');
                showImagePreview();
            } else {
                log('historyLog', '撤銷操作失敗', 'error');
                addTestResult('撤銷功能', false, '撤銷功能失敗');
            }
        }

        function testRedo() {
            if (!processor) return;
            
            const success = processor.redo();
            if (success) {
                log('historyLog', '重做操作成功', 'success');
                addTestResult('重做功能', true, '重做功能正常');
                showImagePreview();
            } else {
                log('historyLog', '重做操作失敗', 'error');
                addTestResult('重做功能', false, '重做功能失敗');
            }
        }

        function testReset() {
            if (!processor) return;
            
            const success = processor.resetToOriginal();
            if (success) {
                log('historyLog', '重置操作成功', 'success');
                addTestResult('重置功能', true, '重置功能正常');
                showImagePreview();
            } else {
                log('historyLog', '重置操作失敗', 'error');
                addTestResult('重置功能', false, '重置功能失敗');
            }
        }

        // 輔助函數
        function log(elementId, message, type) {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function enableAllButtons() {
            const buttons = document.querySelectorAll('.button[disabled]');
            buttons.forEach(btn => btn.disabled = false);
        }

        function showImagePreview() {
            if (!processor) return;
            
            const preview = document.getElementById('imagePreview');
            const base64 = processor.toBase64();
            
            if (base64) {
                preview.innerHTML = `
                    <div class="image-item">
                        <h4>處理後圖片</h4>
                        <img src="${base64}" alt="處理後圖片">
                    </div>
                `;
            }
        }

        function addTestResult(testName, passed, message) {
            testResults.push({
                name: testName,
                passed: passed,
                message: message,
                timestamp: new Date().toLocaleTimeString()
            });
            updateTestResults();
        }

        function updateTestResults() {
            const resultsDiv = document.getElementById('testResults');
            const passedTests = testResults.filter(r => r.passed).length;
            const totalTests = testResults.length;
            
            let html = `<h4>測試統計: ${passedTests}/${totalTests} 通過</h4>`;
            
            testResults.forEach(result => {
                const className = result.passed ? 'test-pass' : 'test-fail';
                html += `
                    <div class="test-result ${className}">
                        ${result.passed ? '✅' : '❌'} ${result.name}: ${result.message}
                        <small>(${result.timestamp})</small>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html> 