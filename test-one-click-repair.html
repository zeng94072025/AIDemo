<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一鍵修復功能測試</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            color: white;
            border-radius: 16px;
        }
        
        .test-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .test-section h2 {
            color: #007AFF;
            margin-bottom: 15px;
        }
        
        .upload-area {
            border: 2px dashed #007AFF;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #5856D6;
            background: #f0f0f0;
        }
        
        .upload-area.dragover {
            border-color: #34C759;
            background: #e8f5e8;
        }
        
        .preview-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .preview-box {
            flex: 1;
            text-align: center;
        }
        
        .preview-box h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .test-button {
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3);
        }
        
        .test-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007AFF, #5856D6);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.info {
            color: #007AFF;
        }
        
        .log-entry.success {
            color: #28a745;
        }
        
        .log-entry.error {
            color: #dc3545;
        }
        
        .log-entry.warning {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1><i class="fas fa-magic"></i> 智能一鍵修復功能測試</h1>
            <p>測試AI智能去除背景和無關人物，自動補充背景的功能</p>
        </div>
        
        <div class="test-section">
            <h2><i class="fas fa-upload"></i> 上傳測試圖片</h2>
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #007AFF; margin-bottom: 15px;"></i>
                <p>拖拽或點擊上傳包含人物的圖片</p>
                <p style="font-size: 14px; color: #666; margin-top: 10px;">
                    支持 JPG、PNG、GIF、WEBP、BMP 格式
                </p>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                <button class="test-button" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-folder-open"></i> 選擇文件
                </button>
            </div>
        </div>
        
        <div class="test-section">
            <h2><i class="fas fa-cogs"></i> 處理控制</h2>
            <button class="test-button" id="testOneClickRepair" disabled>
                <i class="fas fa-user-check"></i> 執行智能一鍵修復
            </button>
            <button class="test-button" id="testDownload" disabled>
                <i class="fas fa-download"></i> 下載結果
            </button>
            <button class="test-button" id="resetTest">
                <i class="fas fa-redo"></i> 重置測試
            </button>
            
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div id="statusContainer"></div>
        </div>
        
        <div class="test-section">
            <h2><i class="fas fa-images"></i> 處理結果預覽</h2>
            <div class="preview-container" id="previewContainer" style="display: none;">
                <div class="preview-box">
                    <h3>原始圖片</h3>
                    <img id="originalImage" class="preview-image" alt="原始圖片">
                </div>
                <div class="preview-box">
                    <h3>修復後圖片</h3>
                    <img id="processedImage" class="preview-image" alt="修復後圖片">
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2><i class="fas fa-terminal"></i> 處理日誌</h2>
            <div class="log-container" id="logContainer">
                <div class="log-entry info">等待上傳圖片...</div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript文件 -->
    <script src="js/utils.js"></script>
    <script src="js/aiImageProcessor.js"></script>
    <script>
        class OneClickRepairTest {
            constructor() {
                this.aiProcessor = null;
                this.originalFile = null;
                this.processedData = null;
                this.isProcessing = false;
                
                this.init();
            }
            
            init() {
                this.initEventListeners();
                this.log('測試頁面初始化完成', 'info');
            }
            
            initEventListeners() {
                // 文件上傳
                const fileInput = document.getElementById('fileInput');
                const uploadArea = document.getElementById('uploadArea');
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFileSelect(e.target.files[0]);
                    }
                });
                
                // 拖拽上傳
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    if (e.dataTransfer.files.length > 0) {
                        this.handleFileSelect(e.dataTransfer.files[0]);
                    }
                });
                
                // 測試按鈕
                document.getElementById('testOneClickRepair').addEventListener('click', () => {
                    this.testOneClickRepair();
                });
                
                document.getElementById('testDownload').addEventListener('click', () => {
                    this.downloadResult();
                });
                
                document.getElementById('resetTest').addEventListener('click', () => {
                    this.resetTest();
                });
            }
            
            async handleFileSelect(file) {
                try {
                    this.log(`開始處理文件: ${file.name}`, 'info');
                    
                    // 驗證文件類型
                    if (!file.type.startsWith('image/')) {
                        throw new Error('請選擇圖片文件');
                    }
                    
                    this.originalFile = file;
                    
                    // 顯示原始圖片
                    const originalImage = document.getElementById('originalImage');
                    const url = URL.createObjectURL(file);
                    originalImage.src = url;
                    
                    // 顯示預覽容器
                    document.getElementById('previewContainer').style.display = 'flex';
                    
                    // 啟用測試按鈕
                    document.getElementById('testOneClickRepair').disabled = false;
                    
                    this.log(`文件載入成功: ${file.name} (${file.size} bytes)`, 'success');
                    this.updateStatus('文件載入成功', 'success');
                    
                } catch (error) {
                    this.log(`文件處理失敗: ${error.message}`, 'error');
                    this.updateStatus(`文件處理失敗: ${error.message}`, 'error');
                }
            }
            
            async testOneClickRepair() {
                if (!this.originalFile) {
                    this.log('請先上傳圖片', 'warning');
                    return;
                }
                
                if (this.isProcessing) {
                    this.log('正在處理中，請稍候', 'warning');
                    return;
                }
                
                this.isProcessing = true;
                this.log('開始智能一鍵修復測試...', 'info');
                
                try {
                    // 創建AI處理器
                    this.aiProcessor = new AIImageProcessor();
                    
                    // 載入圖片
                    await this.aiProcessor.loadImage(this.originalFile);
                    this.log('圖片載入到AI處理器成功', 'success');
                    
                    // 顯示進度條
                    this.showProgress();
                    this.updateProgress(20, 'AI處理器初始化完成');
                    
                    // 執行智能一鍵修復
                    this.updateProgress(40, '開始智能一鍵修復處理...');
                    const success = await this.aiProcessor.oneClickRepair();
                    
                    if (success) {
                        this.updateProgress(80, '智能一鍵修復完成，生成結果...');
                        
                        // 獲取處理結果
                        const processedBase64 = this.aiProcessor.toBase64('image/png', 0.9);
                        
                        if (processedBase64) {
                            this.processedData = processedBase64;
                            
                            // 顯示處理結果
                            document.getElementById('processedImage').src = processedBase64;
                            
                            // 啟用下載按鈕
                            document.getElementById('testDownload').disabled = false;
                            
                            this.log('智能一鍵修復測試成功完成', 'success');
                            this.updateStatus('智能一鍵修復測試成功', 'success');
                            this.updateProgress(100, '測試完成');
                            
                        } else {
                            throw new Error('處理結果生成失敗');
                        }
                        
                    } else {
                        throw new Error('一鍵修復處理失敗');
                    }
                    
                } catch (error) {
                    this.log(`智能一鍵修復測試失敗: ${error.message}`, 'error');
                    this.updateStatus(`測試失敗: ${error.message}`, 'error');
                    this.updateProgress(0, '測試失敗');
                } finally {
                    this.isProcessing = false;
                    this.hideProgress();
                }
            }
            
            downloadResult() {
                if (!this.processedData) {
                    this.log('沒有可下載的處理結果', 'warning');
                    return;
                }
                
                try {
                    // 轉換Base64為Blob
                    const byteString = atob(this.processedData.split(',')[1]);
                    const mimeString = this.processedData.split(',')[0].split(':')[1].split(';')[0];
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    
                    for (let i = 0; i < byteString.length; i++) {
                        ia[i] = byteString.charCodeAt(i);
                    }
                    
                    const blob = new Blob([ab], { type: mimeString });
                    
                    // 生成文件名
                    const originalName = this.originalFile.name;
                    const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.'));
                    const filename = `${nameWithoutExt}_repaired.png`;
                    
                    // 下載文件
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.log(`文件下載成功: ${filename}`, 'success');
                    this.updateStatus('文件下載成功', 'success');
                    
                } catch (error) {
                    this.log(`文件下載失敗: ${error.message}`, 'error');
                    this.updateStatus(`下載失敗: ${error.message}`, 'error');
                }
            }
            
            resetTest() {
                // 清空文件
                this.originalFile = null;
                this.processedData = null;
                
                // 清空圖片
                document.getElementById('originalImage').src = '';
                document.getElementById('processedImage').src = '';
                document.getElementById('previewContainer').style.display = 'none';
                
                // 禁用按鈕
                document.getElementById('testOneClickRepair').disabled = true;
                document.getElementById('testDownload').disabled = true;
                
                // 清空狀態
                this.updateStatus('測試已重置', 'info');
                this.hideProgress();
                
                // 清空日誌
                document.getElementById('logContainer').innerHTML = '<div class="log-entry info">測試已重置，等待上傳圖片...</div>';
                
                this.log('測試已重置', 'info');
            }
            
            log(message, type = 'info') {
                const logContainer = document.getElementById('logContainer');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            updateStatus(message, type) {
                const statusContainer = document.getElementById('statusContainer');
                statusContainer.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
            
            showProgress() {
                document.getElementById('progressBar').style.display = 'block';
            }
            
            hideProgress() {
                document.getElementById('progressBar').style.display = 'none';
            }
            
            updateProgress(percentage, text) {
                document.getElementById('progressFill').style.width = `${percentage}%`;
                this.log(`進度: ${percentage}% - ${text}`, 'info');
            }
        }
        
        // 初始化測試
        document.addEventListener('DOMContentLoaded', () => {
            window.testApp = new OneClickRepairTest();
        });
    </script>
</body>
</html> 