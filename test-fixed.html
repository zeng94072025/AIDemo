<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖片處理功能 - 徹底修復版</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f7;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #333;
        }
        .upload-area {
            border: 2px dashed #007AFF;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            background-color: #f0f8ff;
        }
        .upload-area.dragover {
            background-color: #e3f2fd;
            border-color: #2196F3;
        }
        .preview-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .preview-item {
            flex: 1;
            text-align: center;
        }
        .preview-item img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: #007AFF;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056CC;
        }
        .btn-secondary {
            background-color: #6C757D;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545B62;
        }
        .btn-success {
            background-color: #28A745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1E7E34;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.success {
            background-color: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }
        .status.error {
            background-color: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }
        .status.info {
            background-color: #D1ECF1;
            color: #0C5460;
            border: 1px solid #BEE5EB;
        }
        .file-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
        }
        .download-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e8;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>圖片處理功能 - 徹底修復版</h1>
        <p>使用 SimpleImageProcessor 徹底解決圖片破損問題</p>
        
        <div class="test-section">
            <h2>1. 圖片上傳測試</h2>
            <div class="upload-area" id="uploadArea">
                <p>點擊或拖拽圖片到這裡</p>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>
            <div id="uploadStatus" class="status" style="display: none;"></div>
            <div id="fileInfo" class="file-info" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>2. 圖片處理測試</h2>
            <div class="controls">
                <button class="btn btn-primary" onclick="testBrightness()">提亮</button>
                <button class="btn btn-primary" onclick="testContrast()">增加對比度</button>
                <button class="btn btn-primary" onclick="testGrayscale()">黑白濾鏡</button>
                <button class="btn btn-primary" onclick="testSepia()">復古濾鏡</button>
                <button class="btn btn-primary" onclick="testInvert()">反轉濾鏡</button>
                <button class="btn btn-secondary" onclick="resetImage()">重置</button>
            </div>
            <div id="processStatus" class="status" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>3. 預覽對比</h2>
            <div class="preview-container">
                <div class="preview-item">
                    <h3>原始圖片</h3>
                    <img id="originalPreview" src="" alt="原始圖片" style="display: none;">
                    <div id="originalPlaceholder">等待上傳圖片</div>
                </div>
                <div class="preview-item">
                    <h3>處理後圖片</h3>
                    <img id="processedPreview" src="" alt="處理後圖片" style="display: none;">
                    <div id="processedPlaceholder">等待處理</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>4. 下載測試</h2>
            <div class="download-section">
                <p><strong>重要：</strong> 下載的圖片應該可以正常打開，不會出現"圖片已破損"的問題。</p>
                <div class="controls">
                    <button class="btn btn-success" onclick="downloadOriginal()">下載原始圖片</button>
                    <button class="btn btn-success" onclick="downloadProcessed()">下載處理後圖片</button>
                    <button class="btn btn-success" onclick="downloadJPEG()">下載為JPEG</button>
                    <button class="btn btn-success" onclick="downloadPNG()">下載為PNG</button>
                </div>
                <div id="downloadStatus" class="status" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/simpleImageProcessor.js"></script>
    
    <script>
        let imageProcessor = null;
        let originalFile = null;
        let originalImageData = null;
        let processedImageData = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initUploadArea();
            showStatus('uploadStatus', 'info', '請上傳一張圖片進行測試');
        });

        // 初始化上傳區域
        function initUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        // 處理文件選擇
        async function handleFileSelect(file) {
            try {
                showStatus('uploadStatus', 'info', '正在載入圖片...');
                
                if (!Utils.isValidImageFile(file)) {
                    showStatus('uploadStatus', 'error', '請選擇有效的圖片文件');
                    return;
                }

                // 創建圖片處理器
                imageProcessor = new SimpleImageProcessor();
                originalFile = file;
                
                // 載入圖片
                await imageProcessor.loadImage(file);
                
                // 獲取原始圖片數據
                originalImageData = imageProcessor.toBase64();
                processedImageData = originalImageData;
                
                // 顯示預覽
                document.getElementById('originalPreview').src = originalImageData;
                document.getElementById('originalPreview').style.display = 'block';
                document.getElementById('originalPlaceholder').style.display = 'none';
                
                document.getElementById('processedPreview').src = processedImageData;
                document.getElementById('processedPreview').style.display = 'block';
                document.getElementById('processedPlaceholder').style.display = 'none';
                
                // 顯示文件信息
                showFileInfo(file);
                
                showStatus('uploadStatus', 'success', '圖片載入成功！');
                showStatus('processStatus', 'info', '圖片已準備就緒，可以開始測試處理功能');
                
            } catch (error) {
                console.error('載入圖片失敗:', error);
                showStatus('uploadStatus', 'error', '載入圖片失敗: ' + error.message);
            }
        }

        // 顯示文件信息
        function showFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `
                <strong>文件信息：</strong><br>
                文件名：${file.name}<br>
                文件大小：${Utils.formatFileSize(file.size)}<br>
                文件類型：${file.type}<br>
                最後修改：${new Date(file.lastModified).toLocaleString()}
            `;
            fileInfo.style.display = 'block';
        }

        // 測試提亮功能
        async function testBrightness() {
            if (!imageProcessor) {
                showStatus('processStatus', 'error', '請先上傳圖片');
                return;
            }
            
            try {
                showStatus('processStatus', 'info', '正在應用提亮效果...');
                imageProcessor.adjustBrightness(30);
                processedImageData = imageProcessor.toBase64();
                updateProcessedPreview();
                showStatus('processStatus', 'success', '提亮效果應用成功！');
            } catch (error) {
                console.error('提亮處理失敗:', error);
                showStatus('processStatus', 'error', '提亮處理失敗: ' + error.message);
            }
        }

        // 測試對比度功能
        async function testContrast() {
            if (!imageProcessor) {
                showStatus('processStatus', 'error', '請先上傳圖片');
                return;
            }
            
            try {
                showStatus('processStatus', 'info', '正在增加對比度...');
                imageProcessor.adjustContrast(30);
                processedImageData = imageProcessor.toBase64();
                updateProcessedPreview();
                showStatus('processStatus', 'success', '對比度調整成功！');
            } catch (error) {
                console.error('對比度處理失敗:', error);
                showStatus('processStatus', 'error', '對比度處理失敗: ' + error.message);
            }
        }

        // 測試黑白濾鏡
        async function testGrayscale() {
            if (!imageProcessor) {
                showStatus('processStatus', 'error', '請先上傳圖片');
                return;
            }
            
            try {
                showStatus('processStatus', 'info', '正在應用黑白濾鏡...');
                imageProcessor.applyFilter('grayscale');
                processedImageData = imageProcessor.toBase64();
                updateProcessedPreview();
                showStatus('processStatus', 'success', '黑白濾鏡應用成功！');
            } catch (error) {
                console.error('黑白濾鏡處理失敗:', error);
                showStatus('processStatus', 'error', '黑白濾鏡處理失敗: ' + error.message);
            }
        }

        // 測試復古濾鏡
        async function testSepia() {
            if (!imageProcessor) {
                showStatus('processStatus', 'error', '請先上傳圖片');
                return;
            }
            
            try {
                showStatus('processStatus', 'info', '正在應用復古濾鏡...');
                imageProcessor.applyFilter('sepia');
                processedImageData = imageProcessor.toBase64();
                updateProcessedPreview();
                showStatus('processStatus', 'success', '復古濾鏡應用成功！');
            } catch (error) {
                console.error('復古濾鏡處理失敗:', error);
                showStatus('processStatus', 'error', '復古濾鏡處理失敗: ' + error.message);
            }
        }

        // 測試反轉濾鏡
        async function testInvert() {
            if (!imageProcessor) {
                showStatus('processStatus', 'error', '請先上傳圖片');
                return;
            }
            
            try {
                showStatus('processStatus', 'info', '正在應用反轉濾鏡...');
                imageProcessor.applyFilter('invert');
                processedImageData = imageProcessor.toBase64();
                updateProcessedPreview();
                showStatus('processStatus', 'success', '反轉濾鏡應用成功！');
            } catch (error) {
                console.error('反轉濾鏡處理失敗:', error);
                showStatus('processStatus', 'error', '反轉濾鏡處理失敗: ' + error.message);
            }
        }

        // 重置圖片
        async function resetImage() {
            if (!imageProcessor || !originalFile) {
                showStatus('processStatus', 'error', '請先上傳圖片');
                return;
            }
            
            try {
                showStatus('processStatus', 'info', '正在重置圖片...');
                imageProcessor.resetToOriginal();
                processedImageData = imageProcessor.toBase64();
                updateProcessedPreview();
                showStatus('processStatus', 'success', '圖片重置成功！');
            } catch (error) {
                console.error('重置圖片失敗:', error);
                showStatus('processStatus', 'error', '重置圖片失敗: ' + error.message);
            }
        }

        // 下載原始圖片
        async function downloadOriginal() {
            if (!imageProcessor) {
                showStatus('downloadStatus', 'error', '請先上傳圖片');
                return;
            }
            
            try {
                showStatus('downloadStatus', 'info', '正在準備下載原始圖片...');
                const blob = await imageProcessor.toBlob('image/jpeg', 0.9);
                const filename = `original_${originalFile.name}`;
                Utils.downloadFile(blob, filename);
                showStatus('downloadStatus', 'success', '原始圖片下載成功！');
            } catch (error) {
                console.error('下載原始圖片失敗:', error);
                showStatus('downloadStatus', 'error', '下載原始圖片失敗: ' + error.message);
            }
        }

        // 下載處理後圖片
        async function downloadProcessed() {
            if (!imageProcessor) {
                showStatus('downloadStatus', 'error', '請先上傳圖片');
                return;
            }
            
            try {
                showStatus('downloadStatus', 'info', '正在準備下載處理後圖片...');
                const blob = await imageProcessor.toBlob('image/jpeg', 0.9);
                const filename = `processed_${originalFile.name}`;
                Utils.downloadFile(blob, filename);
                showStatus('downloadStatus', 'success', '處理後圖片下載成功！');
            } catch (error) {
                console.error('下載處理後圖片失敗:', error);
                showStatus('downloadStatus', 'error', '下載處理後圖片失敗: ' + error.message);
            }
        }

        // 下載為JPEG
        async function downloadJPEG() {
            if (!imageProcessor) {
                showStatus('downloadStatus', 'error', '請先上傳圖片');
                return;
            }
            
            try {
                showStatus('downloadStatus', 'info', '正在準備下載JPEG格式...');
                const blob = await imageProcessor.toBlob('image/jpeg', 0.9);
                const filename = `processed_${originalFile.name.replace(/\.[^/.]+$/, '')}.jpg`;
                Utils.downloadFile(blob, filename);
                showStatus('downloadStatus', 'success', 'JPEG格式下載成功！');
            } catch (error) {
                console.error('下載JPEG失敗:', error);
                showStatus('downloadStatus', 'error', '下載JPEG失敗: ' + error.message);
            }
        }

        // 下載為PNG
        async function downloadPNG() {
            if (!imageProcessor) {
                showStatus('downloadStatus', 'error', '請先上傳圖片');
                return;
            }
            
            try {
                showStatus('downloadStatus', 'info', '正在準備下載PNG格式...');
                const blob = await imageProcessor.toBlob('image/png', 1.0);
                const filename = `processed_${originalFile.name.replace(/\.[^/.]+$/, '')}.png`;
                Utils.downloadFile(blob, filename);
                showStatus('downloadStatus', 'success', 'PNG格式下載成功！');
            } catch (error) {
                console.error('下載PNG失敗:', error);
                showStatus('downloadStatus', 'error', '下載PNG失敗: ' + error.message);
            }
        }

        // 更新處理後預覽
        function updateProcessedPreview() {
            try {
                if (processedImageData) {
                    document.getElementById('processedPreview').src = processedImageData;
                }
            } catch (error) {
                console.error('更新預覽失敗:', error);
            }
        }

        // 顯示狀態信息
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `status ${type}`;
                element.textContent = message;
                element.style.display = 'block';
            }
        }
    </script>
</body>
</html> 